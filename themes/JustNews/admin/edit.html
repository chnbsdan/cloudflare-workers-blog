<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>编辑文章 - CF-blog后台</title>
    <link rel="icon" type="image/x-icon" href="https://cdn.jsdelivr.net/gh/gdtool/zhaopp/cfblog/favicon.ico" />
	<link rel="shortcut icon" type="image/x-icon"  href="https://cdn.jsdelivr.net/gh/gdtool/zhaopp/cfblog/favicon.ico"/>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/arya-markdown-editor/dist/arya.min.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap-select/1.9.4/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    
    <script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-zh_CN.min.js"></script>
	<style>
		.bootstrap-select>.dropdown-toggle {
		z-index:auto;
		}
        #arya-editor-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
	</style>
	
</head>
<body>

<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid">

	<div>
		<ul id="myTab" class="nav nav-tabs">
			<li class="active">
				<a href="/admin/" >返回文章</a>
			</li>
		</ul>
	</div>
	</div>
</nav>
<div id="myTabContent" class="tab-content" style="padding-top: 60px;">

		<div class="container">
			<h3>编辑文章</h3>   

			<form id="editForm" class="form-inline"  action="/" >

				<div class="form-group" style="width: 98%">
					<input type="hidden" class="form-control" name="id" id="id" readonly required="true">
					<input type="text" class="form-control" name="title" id="title" placeholder="标题" style="width: 800px;" required="true">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">特色图片</label>
					<input type="url" class="form-control" style="width: 400px;"  name="img" id="img" placeholder="" >
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">永久链接</label>
					<input type="text" class="form-control" name="link" id="link" placeholder="" style="vertical-align:left !important;" required="true">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">创建日期</label>
					<input type="datetime-local" class="form-control" id="createDate" name="createDate" placeholder="" style="vertical-align:left !important;" required="true">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">分类</label>
					<select class="selectpicker" multiple name="category[]" id="category">
					</select>
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">标签</label>
					<input type="text" class="form-control" name="tags" id="tags" placeholder="标签1,标签2">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">权重</label>
					<input type="text" class="form-control" name="priority" id="priority" value='0.5' placeholder="权重">
				</div>
				<div class="form-group">
					<label for="exampleInputEmail2">更新频率</label>
					    <select class="form-control" id="changefreq" name="changefreq">
						<option value="daily" >daily</option>
						<option value="hourly" >hourly</option>
						<option value="weekly" >weekly</option>
						<option value="monthly" >monthly</option>
						<option value="yearly" >yearly</option>
						<option value="never" >never</option>
						<option value="always" >always</option>
					    </select>
				</div>
					<a tabindex="0"  role="button"  type="submit" id="btn_saveEdit" class="btn btn-default" onclick="saveEdit()">保存</a>
					<a  type="submit" role="button" id="btn_delete" class="btn btn-warning" onclick="deleteArticle()">删除</a>
				
				<!-- Arya 编辑器容器 -->
				<div id="arya-editor-container">
					<textarea id="content-markdown-doc" name="content-markdown-doc" style="display:none;"></textarea>
					<textarea id="content-html-code" name="content-html-code" style="display:none;"></textarea>
				</div>
			</form>
		</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/arya-markdown-editor/dist/arya.min.js"></script>   
<script type="text/javascript">
	// 全局变量声明
	let aryaEditor = null;

	$(function() {
		$('#myTab li:eq(0) a').tab('show');
		//获取文章
		var articleJson = <!--{articleJson}-->;
		//获取分类
		var categoryJson = <!--{categoryJson}-->;

		// 初始化 Arya 编辑器
		function initAryaEditor() {
			if (typeof Arya === 'undefined') {
				console.error('Arya editor not loaded');
				// 备用方案：显示一个文本区域
				$('#arya-editor-container').html('<textarea style="width:100%;height:600px;" name="content-markdown-doc" id="content-markdown-doc">' + (articleJson.contentMD || '') + '</textarea>');
				return;
			}
			
			try {
				aryaEditor = new Arya({
					el: '#arya-editor-container',
					value: articleJson.contentMD || '',
					height: '600px',
					// 多媒体增强配置
					video: {
						enabled: true,
						platforms: ['bilibili', 'youtube', 'youku', 'tencent', 'iqiyi']
					},
					audio: {
						enabled: true,
						supportBackground: true
					},
					image: {
						upload: true,
						maxSize: 10 * 1024 * 1024
					},
					toolbar: {
						items: [
							'headings', 'bold', 'italic', 'strike', 'link', '|',
							'quote', 'code', 'inline-code', '|',
							'unordered-list', 'ordered-list', '|',
							'table', '|',
							'image', 'video', 'audio', '|',
							'undo', 'redo', '|',
							'fullscreen'
						]
					},
					onSave: function(markdown, html) {
						$('#content-markdown-doc').val(markdown);
						$('#content-html-code').val(html);
					},
					onChange: function(markdown, html) {
						$('#content-markdown-doc').val(markdown);
						$('#content-html-code').val(html);
					}
				});
				
				console.log('Arya editor initialized successfully');
			} catch (error) {
				console.error('Failed to initialize Arya editor:', error);
				// 备用方案
				$('#arya-editor-container').html('<textarea style="width:100%;height:600px;" name="content-markdown-doc" id="content-markdown-doc">' + (articleJson.contentMD || '') + '</textarea>');
			}
		}

		// 初始化编辑器
		initAryaEditor();

		//表单赋值
		$('#id').val(articleJson.id);
		$('#title').val(articleJson.title);
		$('#img').val(articleJson.img);
		$('#link').val(articleJson.link);
		$('#createDate').val(articleJson.createDate.replace(" ","T"));
		$('#tags').val(articleJson.tags);
		$('#priority').val( (articleJson.priority=== undefined ? "0.5":articleJson.priority) );
		$('#changefreq').selectpicker('val', (articleJson.changefreq === undefined ? "daily":articleJson.changefreq));
	
		$('#WidgetCategory').val(JSON.stringify(categoryJson));
		var category = $('#category');
		category.empty();
		for (var i = 0; i < categoryJson.length; i++) {
			category.append('<option id=' + categoryJson[i] + ' value=' + categoryJson[i] + '>' + categoryJson[i] + '</option>');
		}
		category.selectpicker('val',articleJson.category);

		// 表单提交前确保内容已同步
		$('#editForm').on('submit', function(e) {
			e.preventDefault();
			if (aryaEditor) {
				const { markdown, html } = aryaEditor.getValue();
				$('#content-markdown-doc').val(markdown);
				$('#content-html-code').val(html);
			}
			saveEdit();
		});
	});
    
    //保存按钮(编辑)
    function saveEdit(){
        // 确保编辑器内容已同步
        if (aryaEditor) {
            const { markdown, html } = aryaEditor.getValue();
            $('#content-markdown-doc').val(markdown);
            $('#content-html-code').val(html);
        }

        $.ajax({
            type: "POST",
            dataType: "json",
			contentType: "application/json; charset=utf-8",
            url: "/admin/saveEdit/",
            data: JSON.stringify($("#editForm").serializeArray()), 
            success: function (result) {
                alert(result.msg);
                if(result.rst){
                    // 保存成功后的操作
                }
            },
            error: function(xhr, status, error) {
                alert('保存失败: ' + error);
            }
        });
    }
    
    //删除
    function deleteArticle(){
        if (confirm("确定删除吗?删除后重新发布才能生效")==false){ 
            return false; 
          }
        $.ajax({
            type: "POST",
            dataType: "json",
			contentType: "application/json; charset=utf-8",
            url: "/admin/delete/"+$('#id').val(),
            data: [{"id":$('#id').val()}],
            success: function (result) {
                alert(result.msg);
            }
        });
    }
</script>
  
</body>
</html>
