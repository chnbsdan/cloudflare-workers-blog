<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>编辑文章 - CF-blog后台</title>
    <link rel="icon" type="image/x-icon" href="https://cdn.jsdelivr.net/gh/gdtool/zhaopp/cfblog/favicon.ico" />
	<link rel="shortcut icon" type="image/x-icon"  href="https://cdn.jsdelivr.net/gh/gdtool/zhaopp/cfblog/favicon.ico"/>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap-select/1.9.4/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    
    <!-- Toast UI Editor CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@toast-ui/editor@3.2.2/dist/toastui-editor.min.css" />
    
    <script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/i18n/defaults-zh_CN.min.js"></script>
	<style>
		.bootstrap-select>.dropdown-toggle {
		z-index:auto;
		}
        .form-group {
            margin-bottom: 15px;
        }
        #toast-editor-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .editor-actions {
            margin: 15px 0;
            text-align: right;
        }
	</style>
	
</head>
<body>

<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid">
	<div>
		<ul id="myTab" class="nav nav-tabs">
			<li class="active">
				<a href="/admin/" >返回文章列表</a>
			</li>
		</ul>
	</div>
	</div>
</nav>

<div id="myTabContent" class="tab-content" style="padding-top: 60px;">
	<div class="container">
		<h3>编辑文章</h3>   

		<form id="editForm" class="form-horizontal" action="/">
			<!-- 文章基本信息 -->
			<div class="form-group">
				<label for="title" class="col-sm-2 control-label">文章标题</label>
				<div class="col-sm-10">
					<input type="hidden" class="form-control" name="id" id="id" readonly required>
					<input type="text" class="form-control" name="title" id="title" placeholder="请输入文章标题" required>
				</div>
			</div>

			<div class="form-group">
				<label for="img" class="col-sm-2 control-label">特色图片</label>
				<div class="col-sm-10">
					<input type="url" class="form-control" name="img" id="img" placeholder="https://example.com/image.jpg">
					<small class="text-muted">请输入图片URL地址</small>
				</div>
			</div>

			<div class="form-group">
				<label for="link" class="col-sm-2 control-label">永久链接</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" name="link" id="link" placeholder="article-url" required>
					<small class="text-muted">用于生成文章URL，请使用英文、数字和连字符</small>
				</div>
			</div>

			<div class="form-group">
				<label for="createDate" class="col-sm-2 control-label">发布日期</label>
				<div class="col-sm-10">
					<input type="datetime-local" class="form-control" id="createDate" name="createDate" required>
				</div>
			</div>

			<div class="form-group">
				<label for="category" class="col-sm-2 control-label">文章分类</label>
				<div class="col-sm-10">
					<select class="selectpicker" multiple name="category[]" id="category" required>
						<!-- 分类选项将通过JavaScript动态加载 -->
					</select>
				</div>
			</div>

			<div class="form-group">
				<label for="tags" class="col-sm-2 control-label">文章标签</label>
				<div class="col-sm-10">
					<input type="text" class="form-control" name="tags" id="tags" placeholder标签1,标签2,标签3">
					<small class="text-muted">多个标签请用英文逗号分隔</small>
				</div>
			</div>

			<!-- SEO 设置 -->
			<div class="form-group">
				<label for="priority" class="col-sm-2 control-label">权重优先级</label>
				<div class="col-sm-4">
					<input type="number" class="form-control" name="priority" id="priority" value="0.5" min="0.1" max="1.0" step="0.1">
					<small class="text-muted">搜索引擎权重，0.1-1.0</small>
				</div>
				
				<label for="changefreq" class="col-sm-2 control-label">更新频率</label>
				<div class="col-sm-4">
					<select class="form-control" id="changefreq" name="changefreq">
						<option value="daily">daily - 每日</option>
						<option value="hourly">hourly - 每小时</option>
						<option value="weekly">weekly - 每周</option>
						<option value="monthly">monthly - 每月</option>
						<option value="yearly">yearly - 每年</option>
						<option value="never">never - 从不</option>
						<option value="always">always - 总是</option>
					</select>
				</div>
			</div>

			<!-- 文章内容编辑器 -->
			<div class="form-group">
				<label class="col-sm-2 control-label">文章内容</label>
				<div class="col-sm-10">
					<!-- Toast UI Editor 容器 -->
					<div id="toast-editor-container"></div>
					
					<!-- 隐藏的表单字段 -->
					<textarea id="content-markdown-doc" name="content-markdown-doc" style="display:none;"></textarea>
					<textarea id="content-html-code" name="content-html-code" style="display:none;"></textarea>
				</div>
			</div>

			<!-- 操作按钮 -->
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<div class="editor-actions">
						<button type="button" class="btn btn-primary" onclick="saveEdit()">
							<span class="glyphicon glyphicon-floppy-disk"></span> 保存文章
						</button>
						<button type="button" class="btn btn-warning" onclick="previewArticle()">
							<span class="glyphicon glyphicon-eye-open"></span> 预览文章
						</button>
						<button type="button" class="btn btn-danger" onclick="deleteArticle()">
							<span class="glyphicon glyphicon-trash"></span> 删除文章
						</button>
						<a href="/admin/" class="btn btn-default">
							<span class="glyphicon glyphicon-arrow-left"></span> 返回列表
						</a>
					</div>
				</div>
			</div>
		</form>
	</div>
</div>

<!-- Toast UI Editor JS -->
<script src="https://cdn.jsdelivr.net/npm/@toast-ui/editor@3.2.2/dist/toastui-editor.min.js"></script>

<script type="text/javascript">
	// 全局编辑器变量
	let toastEditor = null;

	$(function() {
		$('#myTab li:eq(0) a').tab('show');
		
		// 获取文章数据
		var articleJson = <!--{articleJson}-->;
		// 获取分类数据
		var categoryJson = <!--{categoryJson}-->;

		console.log('文章数据加载完成:', articleJson);
		console.log('分类数据加载完成:', categoryJson);

		// 初始化 Toast UI Editor
		function initToastEditor() {
			if (typeof toastui === 'undefined') {
				console.error('Toast UI Editor 未加载');
				initFallbackEditor();
				return;
			}

			try {
				const Editor = toastui.Editor;
				
				toastEditor = new Editor({
					el: document.querySelector('#toast-editor-container'),
					height: '600px',
					initialEditType: 'markdown',
					previewStyle: 'vertical',
					initialValue: articleJson.contentMD || '# 请输入文章内容\n\n开始编写您的文章...',
					usageStatistics: false,
					toolbarItems: [
						['heading', 'bold', 'italic', 'strike'],
						['hr', 'quote'],
						['ul', 'ol', 'task'],
						['table', 'link'],
						['code', 'codeblock'],
						['scrollSync'],
					],
					hooks: {
						addImageBlobHook: function(blob, callback) {
							// 图片上传处理
							handleImageUpload(blob, callback);
						}
					}
				});
				
				console.log('Toast UI Editor 初始化成功');
				
				// 监听内容变化
				toastEditor.on('change', function() {
					const markdown = toastEditor.getMarkdown();
					const html = toastEditor.getHTML();
					$('#content-markdown-doc').val(markdown);
					$('#content-html-code').val(html);
					console.log('内容已更新');
				});

				// 初始同步内容
				const initialMarkdown = toastEditor.getMarkdown();
				const initialHtml = toastEditor.getHTML();
				$('#content-markdown-doc').val(initialMarkdown);
				$('#content-html-code').val(initialHtml);

			} catch (error) {
				console.error('初始化 Toast UI Editor 时发生错误:', error);
				initFallbackEditor();
			}
		}

		// 备用编辑器（纯文本区域）
		function initFallbackEditor() {
			console.log('使用备用文本编辑器');
			$('#toast-editor-container').html(
				'<textarea style="width:100%;height:600px;border:1px solid #ddd;padding:10px;font-family:monospace;border-radius:4px;" ' +
				'id="fallback-editor" name="content-markdown-doc">' + 
				(articleJson.contentMD || '# 请输入文章内容\n\n开始编写您的文章...') + '</textarea>'
			);
			
			// 监听文本区域变化
			$('#fallback-editor').on('input', function() {
				$('#content-markdown-doc').val($(this).val());
				$('#content-html-code').val($(this).val()); // 简单处理，实际应该转换 Markdown 到 HTML
			});
		}

		// 图片上传处理
		function handleImageUpload(blob, callback) {
			// 创建临时 URL 用于预览
			const imageUrl = URL.createObjectURL(blob);
			
			// 这里可以添加实际的上传逻辑
			// 例如上传到图床后返回真实的图片URL
			console.log('图片上传:', blob);
			
			// 暂时使用临时URL
			callback(imageUrl, '上传的图片');
			
			// 实际使用时应该这样：
			// uploadToImageHost(blob).then(url => {
			//     callback(url, '图片描述');
			// }).catch(error => {
			//     console.error('图片上传失败:', error);
			//     alert('图片上传失败，请重试');
			// });
		}

		// 表单数据初始化
		function initFormData() {
			// 基本表单赋值
			$('#id').val(articleJson.id || '');
			$('#title').val(articleJson.title || '');
			$('#img').val(articleJson.img || '');
			$('#link').val(articleJson.link || '');
			$('#tags').val(articleJson.tags || '');
			$('#priority').val(articleJson.priority || '0.5');
			$('#changefreq').val(articleJson.changefreq || 'daily');

			// 日期处理
			if (articleJson.createDate) {
				$('#createDate').val(articleJson.createDate.replace(" ","T"));
			} else {
				// 默认当前时间
				$('#createDate').val(new Date().toISOString().slice(0, 16));
			}

			// 分类选择器初始化
			var category = $('#category');
			category.empty();
			if (categoryJson && categoryJson.length > 0) {
				for (var i = 0; i < categoryJson.length; i++) {
					category.append('<option value="' + categoryJson[i] + '">' + categoryJson[i] + '</option>');
				}
			} else {
				category.append('<option value="未分类">未分类</option>');
			}
			
			// 设置选中的分类
			if (articleJson.category && articleJson.category.length > 0) {
				category.selectpicker('val', articleJson.category);
			}
			category.selectpicker('refresh');

			console.log('表单数据初始化完成');
		}

		// 初始化编辑器
		initToastEditor();
		
		// 初始化表单数据
		initFormData();

		// 表单提交处理
		$('#editForm').on('submit', function(e) {
			e.preventDefault();
			saveEdit();
		});
	});

	// 保存文章
	function saveEdit() {
		// 验证必填字段
		if (!$('#title').val().trim()) {
			alert('请填写文章标题');
			$('#title').focus();
			return;
		}

		if (!$('#link').val().trim()) {
			alert('请填写永久链接');
			$('#link').focus();
			return;
		}

		if (!$('#createDate').val()) {
			alert('请选择发布日期');
			$('#createDate').focus();
			return;
		}

		// 确保编辑器内容已同步
		if (toastEditor) {
			const markdown = toastEditor.getMarkdown();
			const html = toastEditor.getHTML();
			$('#content-markdown-doc').val(markdown);
			$('#content-html-code').val(html);
		} else if ($('#fallback-editor').length) {
			$('#content-markdown-doc').val($('#fallback-editor').val());
			$('#content-html-code').val($('#fallback-editor').val());
		}

		// 检查文章内容
		const content = $('#content-markdown-doc').val();
		if (!content || content.trim().length < 10) {
			if (!confirm('文章内容较短，确定要保存吗？')) {
				return;
			}
		}

		console.log('开始保存文章...');
		
		// 显示加载状态
		const saveBtn = $('#editForm').find('button[onclick="saveEdit()"]');
		const originalText = saveBtn.html();
		saveBtn.html('<span class="glyphicon glyphicon-refresh spinning"></span> 保存中...').prop('disabled', true);

		$.ajax({
			type: "POST",
			dataType: "json",
			contentType: "application/json; charset=utf-8",
			url: "/admin/saveEdit/",
			data: JSON.stringify($("#editForm").serializeArray()),
			success: function (result) {
				saveBtn.html(originalText).prop('disabled', false);
				if (result.rst) {
					alert('保存成功！');
					console.log('文章保存成功，ID:', result.id);
					// 可以跳转到文章列表或继续编辑
				} else {
					alert('保存失败：' + result.msg);
				}
			},
			error: function(xhr, status, error) {
				saveBtn.html(originalText).prop('disabled', false);
				alert('保存失败，请检查网络连接：' + error);
				console.error('保存错误:', error);
			}
		});
	}

	// 预览文章
	function previewArticle() {
		// 先保存内容到隐藏字段
		if (toastEditor) {
			const markdown = toastEditor.getMarkdown();
			const html = toastEditor.getHTML();
			$('#content-markdown-doc').val(markdown);
			$('#content-html-code').val(html);
		}

		const id = $('#id').val();
		if (id) {
			// 在新窗口打开预览
			window.open('/article/' + id + '/preview.html', '_blank');
		} else {
			alert('请先保存文章再进行预览');
		}
	}

	// 删除文章
	function deleteArticle() {
		const id = $('#id').val();
		const title = $('#title').val();
		
		if (!id) {
			alert('文章ID不存在');
			return;
		}

		if (!confirm('确定要删除文章 "' + (title || '未命名') + '" 吗？此操作不可恢复！')) {
			return;
		}

		$.ajax({
			type: "POST",
			dataType: "json",
			contentType: "application/json; charset=utf-8",
			url: "/admin/delete/" + id,
			data: JSON.stringify([{"id": id}]),
			success: function (result) {
				alert(result.msg);
				if (result.rst) {
					// 删除成功，跳转到文章列表
					window.location.href = '/admin/';
				}
			},
			error: function(xhr, status, error) {
				alert('删除失败：' + error);
			}
		});
	}

	// 生成永久链接
	$('#title').on('blur', function() {
		if (!$('#link').val()) {
			// 简单的中文转拼音函数（实际使用时可能需要更完善的实现）
			function simpleSlug(text) {
				return text
					.toLowerCase()
					.replace(/[^\w\u4e00-\u9fa5]+/g, '-')
					.replace(/^-+|-+$/g, '')
					.replace(/--+/g, '-');
			}
			
			const title = $(this).val().trim();
			if (title) {
				$('#link').val(simpleSlug(title));
			}
		}
	});
</script>

<style>
	/* 加载旋转动画 */
	.glyphicon.spinning {
		animation: spin 1s infinite linear;
	}
	@keyframes spin {
		from { transform: scale(1) rotate(0deg); }
		to { transform: scale(1) rotate(360deg); }
	}
	
	/* 改善表单样式 */
	.form-horizontal .control-label {
		text-align: right;
		font-weight: bold;
	}
	
	/* 改善选择器样式 */
	.bootstrap-select .dropdown-menu {
		z-index: 10000;
	}
</style>

</body>
</html>
